<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="style.css">
<script src="base.js"></script>
<script src="game.js"></script>
<script src="game.rules.js"></script>
<script src="game.map.js"></script>
<script src="game.player.js"></script>
<script src="views.js"></script>
<script src="views.map.js"></script>
<script src="views.map.hover.js"></script>
<script src="views.map.linehover.js"></script>
<script src="views.map.cornerhover.js"></script>
<script src="views.actual.js"></script>
<script src="views.description.js"></script>
<script>

$(function() {
    Views.setElements({main_elem: '.game'});
    const game = new Game({ views: Views });

    // Prompt

    $(document).on('click', '.prompt [type="submit"]', function(e) {
        const elem = $(this).closest('form');

        if (elem.find('[type="text"]').val()) {
            e.preventDefault();// prevent form sending
            Views.Trigger('enter_string', elem.parent().parent());
        }
    });
    $(document).on('click', '.prompt .cancel, .prompt .overlay', function() {
        if ($(this).data('cancel')) {
            Views.hideModalMessage('.prompt');
        }
    });
    $(document).on('enter_string', '.prompt', function() {
        const elem = $(this);
        const validator = elem.data('validator');
        const input = elem.find('input');
        const v = input.val();

        // if validator named and exists
        if (validator && !game[validator](v)) {
            input.val('');
            return;
        }

        Views.hideModalMessage(this);
        const selects = elem.find('select');
        game[elem.data('action')](v, $(selects[0]).val(), $(selects[1]).val());
    });

    // Game Process

    $(document).on('click', '.start_btn', function() {
        if (!Views.isDisabled(this)) {
            game.EnterPlayersCount('NewGame', true);// with Cancel button
        }
    });
    $(document).on('click', '.step_btn', function() {
        if (!Views.isDisabled(this)) {
            Views.Trigger('next_step');
        }
    });
    $(document).on('next_step', function() {
        game.Step();
    });

    // Interaction

    $(document).on('click', '.description .receipt', function() {
        const type = null;

        if (!Views.isDisabled(this)) {
            type = Views.toggleHoverTable(this, game.getCurrentObjectType());
        }

        game.setCurrentObjectType(type);
    });
    $(document).on('click', '.map .corner, .map .line', function() {
        if (game.getCurrentObjectType() && !Views.map.ObjectIsSet(this))
        {
            game.setObject( Views.map.setObject(this) );
        }
    });
    $(document).on('click', '.exchange_btn', function() {
        Views.toggleMenu(this);
    });
    $(document).on('click', '.exchange_btn + .menu > .item', function() {
        Views.dropup();
        const elem = $(this);
        game.Exchange(elem.parent().prev().data('source'), $(this).data('type'));
    });
});
</script>
</head>

<body>
    <div class="game"></div>
</body>
</html>
